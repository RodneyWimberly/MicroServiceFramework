#####################################################
# Logs Stack
# Mongo DB, Elasticsearch, LogAgent, & Graylog
#####################################################
# Ports
# 1514/tcp:udp = graylog:Syslog
# 5555/tcp:udp = graylog:RawPlainText
# 9000/tcp     = graylog:HTTP Web UI and REST API
# 9200/        = elasticsearch:HTTPS
# 9300/tcp     = elasticsearch:HTTP
# 12201/tcp    = graylog:GELF
# 12201/udp    = graylog:GELF
# 12301/tpc:udp= graylog:Nginx Syslog activity
# 12302/tpc:udp= graylog:Nginx Syslog error
# 27017/tcp    = mongo:MongoDB

version: '3.8'

volumes:
  mongo_data:
  elasticsearch_data:
  graylog_data:

networks:
  stack_network:
  admin_network:
    external: true

services:
  logagent:
    image: microserviceframework/logagent:dev
    env_file: 
      - ./logs.env
    depends_on:
      - elasticsearch
    # environment:
    #     LOGS_TOKEN: 177434fe-0862-43e4-a162-de767c346723
    #     LOGS_RECEIVER_URL: http://elasticsearch.service.consul:9200
    #     LOG_GLOB: /mylogs//*.log;/var/log//*.log;/var/log/**/*.log
    #     #LOGAGENT_ARGS: "-n httpd"
    cap_add:
        - SYS_ADMIN
    volumes:
        - '/var/run/docker.sock:/var/run/docker.sock'
        - '/var/log:/mylogs'
    networks:
        stack_network: {}
        admin_network: {}
    dns:
      - 192.168.100.2
      - 192.168.100.3

  mongo:
    image: microserviceframework/mongo:dev
    env_file: 
      - ./logs.env
    volumes:
      - mongo_data:/data/db
    networks:
      admin_network: {}
      stack_network: {}
    dns:
      - 192.168.100.2
      - 192.168.100.3

  elasticsearch:
    image: microserviceframework/elasticsearch:dev
    env_file: 
      - ./logs.env
    depends_on:
       - mongo
    environment:
      - http.host=0.0.0.0
      - network.bind_host=0.0.0.0
      - transport.host=0.0.0.0
      - network.host=0.0.0.0
      - discovery.type=single-node
    #   - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    deploy:
      resources:
        limits:
          memory: 1g
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      admin_network: {}
      stack_network: {}
    dns:
      - 192.168.100.2
      - 192.168.100.3

  graylog:
    image: microserviceframework/graylog:dev
    env_file: 
      - ./logs.env
    # environment:
    #   - GRAYLOG_PASSWORD_SECRET=microserviceframeworksecret
    #   # Password: admin
    #   - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
    #   - GRAYLOG_HTTP_EXTERNAL_URI=http://graylog.service.consul:9000
    depends_on:
      - elasticsearch
    volumes:
      - graylog_data:/usr/share/graylog/data
    networks:
     admin_network: {}
     stack_network: {}
    dns:
      - 192.168.100.2
      - 192.168.100.3
