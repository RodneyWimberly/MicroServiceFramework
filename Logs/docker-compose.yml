#####################################################
# Logs Stack
# Mongo DB, Elasticsearch, LogAgent, & Graylog
#####################################################
# Ports
# 1514/tcp:udp = graylog:Syslog
# 5555/tcp:udp = graylog:RawPlainText
# 9000/tcp     = graylog:HTTP Web UI and REST API
# 9200/        = elasticsearch:HTTPS
# 9300/tcp     = elasticsearch:HTTP
# 12201/tcp    = graylog:GELF
# 12201/udp    = graylog:GELF
# 12301/tpc:udp= graylog:Nginx Syslog activity
# 12302/tpc:udp= graylog:Nginx Syslog error
# 27017/tcp    = mongo:MongoDB

version: '3.8'

volumes:
  mongo_data:
  elasticsearch_data:
  graylog_data:

configs:
  resolv_conf:
    file: ./resolv.conf
  dhclient_conf:
    file: ./dhclient.conf
  graylog_conf:
    file: ./graylog.conf

networks:
  # stack_network:
  admin_network:
    external: true

services:
  logagent:
    image: microserviceframework/logagent:dev
    configs:
      - source: resolv_conf
        target: /etc/templates/resolv.conf
      - source: dhclient_conf
        target: /etc/dhcp/dhclient.conf
    env_file: 
      - ./logs.env
    depends_on:
      - elasticsearch
    cap_add:
        - SYS_ADMIN
    volumes:
        - '/var/run/docker.sock:/var/run/docker.sock'
        - '/var/log:/mylogs'
    networks:
      #  stack_network:
      #   aliases:
      #     - logs-logagent
       admin_network: {}
    dns:
      - 192.168.100.2
      - 192.168.100.3

  mongo:
    image: microserviceframework/mongo:dev
    configs:
      - source: resolv_conf
        target: /etc/templates/resolv.conf
      - source: dhclient_conf
        target: /etc/dhcp/dhclient.conf
    env_file: 
      - ./logs.env
    volumes:
      - mongo_data:/data/db
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      admin_network: {}
      # stack_network:
      #   aliases:
      #     - logs-mongo
    dns:
      - 192.168.100.2
      - 192.168.100.3

  elasticsearch:
    image: microserviceframework/elasticsearch:dev
    configs:
      - source: resolv_conf
        target: /etc/templates/resolv.conf
      - source: dhclient_conf
        target: /etc/dhcp/dhclient.conf
    env_file: 
      - ./logs.env
    depends_on:
       - mongo
    environment:
      - http.host=0.0.0.0
      - network.bind_host=0.0.0.0
      - transport.host=0.0.0.0
      - network.host=0.0.0.0
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    deploy:
      resources:
        limits:
          memory: 1g
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      admin_network: {}
      # stack_network:
      #   aliases:
      #     - logs-elasticsearch
    dns:
      - 192.168.100.2
      - 192.168.100.3

  graylog:
    image: microserviceframework/graylog:dev
    configs:
      - source: resolv_conf
        target: /etc/templates/resolv.conf
      - source: dhclient_conf
        target: /etc/dhcp/dhclient.conf
      # - source: graylog_conf
      #   target: /usr/share/graylog/data/config/graylog.conf
    env_file: 
      - ./logs.env
    depends_on:
      - elasticsearch
    volumes:
      - graylog_data:/usr/share/graylog/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
     admin_network: {}
    #  stack_network:
    #     aliases:
    #       - logs-graylog
    dns:
      - 192.168.100.2
      - 192.168.100.3
